---
title:
subtitle: 
author:
date:
output:
  html_document:
    toc: false
    toc_float: true 
    depth: 2
    number_sections: false
    theme: spacelab
    highlight: pygments
editor_options: 
  markdown: 
    wrap: 150
---

## Session 3

### Basics of Species Distribution Models (SDMs)

|                                 |
|:--------------------------------|
| ![](images/session_3/oceanicwhitetip_banner.png) |

<br>

Species distribution models are instrumental in predicting and understanding the geographic ranges of species. In this session, we will delve into the
use of `dismo`, `mgcv` and `randomForest` R packages, covering the basics of species distribution modelling. This will be a quick run-though over the theory and 
workflow of how to construct SDMs using observational data, and useful resources to help you along the way. Participants will learn how to construct
predictive models and assess habitat suitability for species.

<br>

------------------------------------------------------------------------------------------------------------------------------------------------------

#### Theory and Concept

Species Distribution Models (SDMs) are fundamental tools in ecology and conservation biology, aiming to understand and predict the spatial
distribution of species based on environmental variables. At its core, SDMs are grounded in the ecological niche theory, which suggests that species
occupy specific ecological niches characterised by environmental conditions such as temperature, water quality, and habitat features. By quantifying
the relationship between species occurrence records and environmental variables through statistical modeling techniques, SDMs provide insights into
the ecological requirements and habitat preferences of species.

<br><br>

![(Source: Marcelino and Verbruggen 2015)](images/session_3/0_SDM_schematic.png)

<br><br>

These models typically utilise various algorithms, including MaxEnt, Random Forest, and Generalized Linear Models, to predict species distributions
across geographic areas. We will quickly go through an example dataset, and how different model structures and algorithm can drastically change your
predicted distribution. SDMs have diverse applications, from assessing the potential impacts of climate change on species distributions to informing
conservation planning and management strategies. However, they also come with limitations and uncertainties, including data quality issues,
assumptions about species-environment relationships, and challenges in extrapolating predictions to novel environmental conditions. Continuous
refinement and integration of multiple data sources and modeling approaches are essential for improving the accuracy and reliability of SDMs, thereby
enhancing their utility in addressing pressing ecological and conservation challenges. In this session, we will run though a quick example of how SDMs
are created in R, and the complexities of their development and interpretation.


Here we will provide a quick tour of SDMs, but if you want a more in-depth look at what goes into building and refining a SDM, check out some of these 
online sources ([SDM Intro](https://damariszurell.github.io/SDM-Intro/),[terra vignette](https://rspatial.org/raster/sdm/) and [Ecocommons](https://support.ecocommons.org.au/support/solutions/folders/6000240802/page/1?url_locale=)). There is also a wealth of literature on the subject
that you can refer to, including [this curated list](https://doi.org/10.1016/j.ecolmodel.2022.110242) of R packages that you can use to explore these analyses.


In this session we will use occurrence data on Oceanic Whitetip Sharks (*Carcharhinus longimanus*) from the Indian Ocean to model their distribution
using five commonly used SDM algorithms. We will also finally quickly introduce a simple ensemble model workflow to show how you can integrate outputs
from multiple algorithms to get better predictions of distribution. ***We have provided code to replicate the analysis and plotting, but as we will have***
***limited time during this session, we dont expect everyone to run these code. You can run them on your own time to see how it works!***

<br><br>


------------------------------------------------------------------------------------------------------------------------------------------------------

#### Basic steps of building SDMs


Building a SDM is an iterative process, and typically involves several steps. The paper [Zurell et al. 2020]( https://doi.org/10.1111/ecog.04960) provides a
comprehensive step by step run through of a standard protocol on how to develop SDMs and how to report them in papers to allow for reproducibility. 
Here's a quick overview:

<br><br>

![(Source: Zurell et al. 2020)](images/session_3/0_SDM_steps.png)

<br><br>


***Overview/Conceptualisation -*** One of the key steps in developing SDMs is first conceptualising the objectives, available data, and the relevance of SDMs for your research
question. This includes understanding if SDMs are going to tell you what you need to answer your hypothesis. Similarly, if you do not have 
access to relevant data, then the outputs of SDMs may not be useful (the old GIGO adage: garbage in, gargabe out!). In this step, it is worth 
overviewing and conceptialising the objectives of the modelling excercise, and asscertain if this model is relevant for the taxon, location,
spatial and temporal scale of your study system.

<br>


***Data Collection, preperation and exploration -*** The next step we gather occurrence data for the species of interest (e.g., presence-only or presence-absence data) and environmental variables
(e.g., temperature, bathymetry) that may be biologically relevant for the study area and the species of interest. Organise and clean the data, 
ensuring that it's in a suitable format for analysis. This may involve handling missing values, converting data types, and standardizing units.
Explore the relationships between species occurrence and environmental variables using visualization techniques such as scatter plots, histograms, 
and correlation matrices.

<br>


***Model selection, fitting and training -*** We then choose an appropriate modeling technique for your data. Common SDM algorithms in R include MaxEnt (using the `dismo` package), Generalized 
Linear Models (GLMs) or Generalized Additive Models (GAMs) (using the `mgcv` package), and Random Forest (using the `randomForest` package). We then
Split the data into training and testing sets needed to evaluate model performance further down the track. We finally fit the chosen model using the 
training data. We will cover some of these techincal steps later in this session.

<br>


***Model assessment and exploration -*** Once models have been fit, we assess the performance of the model using evaluation metrics such as Area Under the Receiver Operating Characteristic 
Curve (AUC-ROC), Area Under the Precision-Recall Curve (AUC), or True Skill Statistic (TSS). We also explore the response curves for the model to
identify how each explanatory predictor impacts the probability of presence of your species. Response curves and variable importance plots can tell 
you if the predictor variables used are relevant, or having any influence on the model.

<br>


***Model prediction and visualisation -*** Once the model is trained and evaluated, use it to predict species distributions across the study area based on environmental variables. Visualize 
the predicted species distribution map using mapping packages like `terra` or `ggplot2`, along with additional spatial data if necessary. Validate the 
predicted distributions against the testing subset of data, independent occurrence data or expert knowledge to verify the accuracy and reliability of 
the model. 

<br>


***Refinement and Iteration -*** Refinement is key in SDMs, and you can often go through 10s of iterations before you have a properly fitted model that provides accurate estimates of 
species presence and response curves. Iterate through the modeling process, refining the model and incorporating additional data or variables as needed
to improve accuracy and robustness.


<br><br>

------------------------------------------------------------------------------------------------------------------------------------------------------

#### Data preperation                                       

Here we will go through a quick workflow in R to enable a ***very simple*** SDM, from sourcing occurrence data all the way to building ensemble models. 
Note, this is an overly simplistic example just to get everyone up to speed on how SDMs operate using occurrence data. We will go through how this modelling
workflow can be modified to use movement data to inform distribution models in the next session.

<br>

##### ***Occurrence data***

Occurrence data used for SDMs typically include records of species presence or presence-absence across geographic locations. These data can be obtained from 
various sources, including published literature, museum collections, citizen science projects, and online databases. In R, there are several packages and 
resources available for accessing occurrence data:


- [***GBIF***](https://www.gbif.org) (Global Biodiversity Information Facility): The [`rgbif` package](https://docs.ropensci.org/rgbif/articles/rgbif.html) allows 
you to search and download occurrence records from the GBIF database directly within R.
- [***rvertnet***](https://github.com/ropensci/rvertnet): This package provides access to occurrence data from multiple vertebrate-focused biodiversity data networks,
including VertNet, MaNIS, and ORNIS.
- [***spocc***](https://github.com/ropensci/spocc): This package provides a unified interface to several online species occurrence data sources, including GBIF, 
iNaturalist, and eBird.
- [***ALA***](https://www.ala.org.au) (Atlas of Living Australia): The [`galah`](https://github.com/AtlasOfLivingAustralia/galah-R) package allows you to access 
species occurrence data from the ALA database.
- ***Data repositories***: Many research papers provide access to their occurrence data through online repositories such as [Dryad](https://datadryad.org/stash)
or [Figshare](https://figshare.com). You can download these datasets directly or use APIs if available.



Once you have obtained the occurrence data, you can import it into R using the functions we discussed in Session 1, or specific functions provided by the packages 
mentioned above. Be sure to clean and preprocess the data as needed before using it in your SDM analysis. Here we have accessed some example data on Oceanic Whitetip
Sharks (*Carcharhinus longimanus*) in the Indian Ocean from [GBIF](https://www.gbif.org), and using the code from Session 1 have plotted it using `ggspatial`.

<br>


```{r, eval=FALSE, message=FALSE}
## Lets first load some useful packages
library(tidyverse)
library(sf)
library(terra)
library(ggspatial)
library(dismo)
library(mgcv)
library(visreg)


```



```{r, eval=FALSE}
## We can call on the data from the workshop GitHub page directly

occ <- read_csv("https://raw.githubusercontent.com/vinayudyawer/OCS2024_SDMworkshop/main/data/session_3/Oceanic%20whitetip%20occ.csv")

occ_sf <-
  occ %>% 
  st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = F)

ggplot() + 
  annotation_map_tile('cartolight', zoom = 4) +
  layer_spatial(occ_sf, color = "black") +
  annotation_scale(width_hint = 0.2, location = "br") +
  theme_void()


```


![](images/session_3/1_occ_plot.png)



##### ***Absence or Pseudo-absence data***

Now that we have occurrence data, we need data used to represent locations where a species is presumed to be absent. These data points serve as a contrast to presence
data and are essential for modeling the species' distribution accurately. If we have quantitative data of confirmed absences (i.e., we know for sure this species is 
not found here!), this is very valuable for SDM modelling. However, in most real-world cases, this kind of information is not available. In which case, we use 'presumed'
absence data known as 'pseudo'-absences. Pseudo-absence data are generated using various techniques such as random sampling from areas where the species has not been 
observed, environmental similarity methods, or background sampling from the study area.

In R, generating pseudo-absence data can be done using functions like randomPoints() from the dismo package or randomPoints function from the spatstat package. Additionally,
some SDM packages in R, such as dismo, biomod2, and MaxEnt, include built-in functions for generating pseudo-absence data as part of their modeling workflow.

It's important to note that the selection and quality of pseudo-absence data can significantly impact model performance and interpretation. Careful consideration should be 
given to the method used for generating pseudo-absences to ensure they adequately represent areas where the species is genuinely absent while minimizing sampling bias.




![](images/session_3/2_pseudo_plot.png)


##### ***Environmental predictors***



![](images/session_3/3_env_plot.png)




------------------------------------------------------------------------------------------------------------------------------------------------------

#### Model fitting {.tabset .tabset-fade .tabset-pills}

<a id="session_3"></a>


------------------------------------------------------------------------------------------------------------------------------------------------------

##### Linear models

<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">




![](images/session_3/4_glm_visreg.png)


![](images/session_3/5_glm_persp.png)


![](images/session_3/6_glm_auc.png)



![](images/session_3/7_glm_map.png)




</div>


<br>

------------------------------------------------------------------------------------------------------------------------------------------------------

[Back to top](#session_3)

<br><br>

##### Non-linear models             

<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">



![](images/session_3/8_gam_visreg.png)


![](images/session_3/9_gam_persp.png)


![](images/session_3/10_gam_auc.png)



![](images/session_3/11_gam_map.png)



</div>


<br>

------------------------------------------------------------------------------------------------------------------------------------------------------

[Back to top](#session_3)

<br><br>

##### Classification models

<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">



![](images/session_3/12_rf_visreg.png)


![](images/session_3/13_rf_persp.png)


![](images/session_3/14_rf_auc.png)



![](images/session_3/15_rf_map.png)



</div>


<br>

------------------------------------------------------------------------------------------------------------------------------------------------------

[Back to top](#session_3)

<br><br>

##### Maximum Entropy                      

<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">


![](images/session_3/16_maxent_visreg.png)


![](images/session_3/17_maxent_auc.png)


![](images/session_3/18_max_map.png)




</div>


<br>

------------------------------------------------------------------------------------------------------------------------------------------------------

[Back to top](#session_3)

<br><br>

#### Ensemble model approach

<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">



![](images/session_3/19_ensemble_plot.png)




![](images/session_3/20_ens_map.png)





</div>


<br>


------------------------------------------------------------------------------------------------------------------------------------------------------

<a href="#top" style="color:steelblue; font:bold;" >Back to top</a>

<br><br>






